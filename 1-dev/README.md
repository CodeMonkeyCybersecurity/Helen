# NGINX HTTPS Setup with Certbot

This project sets up an NGINX web server using Docker Compose to serve static files with HTTPS enabled, leveraging Let’s Encrypt certificates generated by Certbot.

### Features

• Lightweight NGINX container based on the nginx:alpine image.

• Automatic HTTPS certificate generation using Certbot.

• Support for serving custom static files from the html directory.

• Automatic redirection from HTTP to HTTPS.

• Docker Compose for easy deployment and management.
 

### Requirements

• Docker and Docker Compose installed on your server.
 
• A domain name (chickenj0.cloud) pointing to your server’s IP address.
 
• Certbot installed on your server for certificate generation.

 

## Project Structure

```
├── docker-compose.yml         # Docker Compose configuration file
├── html/                      # Directory for your static website files
│   └── index.html             # Example HTML file
├── nginx.conf                 # Custom NGINX configuration file
├── certs/                     # Directory for SSL certificates (auto-generated)
└── README.md                  # Documentation for the setup
```
## Setup Instructions

### 1. Clone the Repository

Clone this repository to your server:
```
git clone <repository-url>
cd <repository-directory>
```

Below is a simple, reliable approach to obtain SSL certificates with Certbot and use them in an NGINX Docker container—without battling volume-mount issues for Let’s Encrypt directories. This method involves two separate steps:
1.	Use Certbot on the host (outside of Docker) to obtain certificates.

2.	Mount the certificates into your Dockerized NGINX.

By doing it this way, you avoid dealing with /var/lib/letsencrypt or /etc/letsencrypt inside Docker. Once you have your certificates on the host, you simply share them with the NGINX container.

## Option A: Generate Certificates Directly on the Host
### 1.	Stop Any Services on Port 80
Stop or remove any containers or services (like NGINX) that are currently listening on port 80:
```
docker-compose down
sudo systemctl stop nginx
```
This is necessary because Certbot’s standalone mode needs to bind port 80.

### 2.	Install Certbot on the Host
On Ubuntu/Debian:
```
sudo apt update
sudo apt install certbot
```

### 3.	Obtain the Certificates (Standalone Mode)
Run Certbot to generate certificates using its built-in standalone server:
```
sudo certbot certonly --standalone \
    -d chickenj0.cloud \
    --email main@cybermonkey.dev \
    --agree-tos
```
This will spin up a temporary web server on port 80. Certbot will place certificates in /etc/letsencrypt/live/chickenj0.cloud/.

#### If you're adding Wazuh 
Run Certbot to generate certificates using its built-in standalone server:
```
sudo certbot certonly --standalone \
    -d wazuh.chickenj0.cloud \
    --email main@cybermonkey.dev \
    --agree-tos
```

### 4.	Verify Certificate Files
After a successful run, check:
```
ls -l /etc/letsencrypt/live/chickenj0.cloud/
```

You should see:
•	cert.pem

•	chain.pem

•	fullchain.pem

•	privkey.pem

### 5.	Create a Local Directory for Docker
Make a local directory in your project for the certs:
```
mkdir certs
```
Copy your certificates into it:
```
sudo cp /etc/letsencrypt/live/chickenj0.cloud/fullchain.pem certs/
sudo cp /etc/letsencrypt/live/chickenj0.cloud/privkey.pem certs/
```

Adjust permissions to be readable:
```
sudo chmod 644 certs/fullchain.pem
sudo chmod 600 certs/privkey.pem
```

#### If you're adding Wazuh 
Copy your certificates into it:
```
sudo cp /etc/letsencrypt/live/wazuh.chickenj0.cloud/fullchain.pem certs/wazuh.fullchain.pem
sudo cp /etc/letsencrypt/live/wazuh.chickenj0.cloud/privkey.pem certs/wazuh.privkey.pem
```

Adjust permissions to be readable:
```
sudo chmod 644 certs/wazuh.fullchain.pem
sudo chmod 600 certs/wazuh.privkey.pem
```


### 6.	Use the Certificates in Docker
In your docker-compose.yml, mount the local certs folder into the container:

```
services:
  nginx:
    image: nginx
    container_name: helen-dev
    volumes:
      - ./html:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/etc/nginx/certs:ro
    ports:
      - "80:80"
      - "443:443"
    restart: always
```

### 7.	Configure nginx.conf
Point to the copied certs in /etc/nginx/certs:
```
server {
    listen 80;
    server_name chickenj0.cloud;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name chickenj0.cloud;

    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;

    location / {
        root /usr/share/nginx/html;
        index index.html;
    }
}
```

#### If you're adding Wazuh 
Your nginx.conf file needs to be:
```
server {
    listen 80;
    server_name chickenj0.cloud;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name chickenj0.cloud;

    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;

    location / {
        root /usr/share/nginx/html;
        index index.html;
    }
}

server {
    listen 80;
    server_name wazuh.chickenj0.cloud;
    return 301 https://$host$request_uri;  # Redirect HTTP to HTTPS
}

server {
    listen 443 ssl;
    server_name wazuh.chickenj0.cloud;

    # SSL Certificate settings
    ssl_certificate /etc/nginx/certs/wazuh.fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/wazuh.privkey.pem;

    location / {
        # Forward to your Wazuh Dashboard (on IP ww.xx.yy.zz port 5601)
        # If it's HTTP on the backend:
        proxy_pass https://ww.xx.yy.zz:5601/;

        # If the backend is HTTPS with self-signed cert:
        # proxy_pass https://ww.xx.yy.zz:5601/;
        # proxy_ssl_verify off;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 8.	Start NGINX
With certificates in place and nginx.conf updated, start your container:
```
docker-compose up -d
```
You should now be able to browse to https://wazuh.chickenj0.cloud.

### 9.	Automate Certificate Renewal (Optional)
•	Since Certbot is on your host, just rely on its standard cron-based renewal:
```
sudo certbot renew
```

•	If renewal updates your cert files, copy them again into ./certs/ or symlink them.

•	Then restart the container for changes to take effect:
```
docker-compose restart
```
## Option B: Use a Temporary Certbot Container (Standalone)

If you prefer Docker for everything, here’s a minimal approach:

### 1.	Stop Anything on Port 80
```
docker-compose down
```

### 2.	Run a Standalone Certbot Container
This container listens on port 80, obtains the cert, and saves it to a local folder:
```
docker run -it --rm --name certbot \
  -p 80:80 \
  -v $PWD/letsencrypt/etc:/etc/letsencrypt \
  -v $PWD/letsencrypt/lib:/var/lib/letsencrypt \
  certbot/certbot certonly --standalone \
    -d chickenj0.cloud \
    --email main@cybermonkey.dev \
    --agree-tos \
    --no-eff-email
```
•	This writes certificates to ./letsencrypt/etc/live/chickenj0.cloud/.

### 3.	Mount Certificates into NGINX
Then, in docker-compose.yml, mount these files into your NGINX container:
```
volumes:
  - $PWD/letsencrypt/etc/live/chickenj0.cloud:/etc/nginx/certs:ro
```
Make sure your nginx.conf references fullchain.pem and privkey.pem inside /etc/nginx/certs.

### 4.	Start NGINX
```
docker-compose up -d
```
Your container now uses the certificates you obtained via the temporary Certbot container.

### 5.	Renewal
Rerun the Certbot container every 60 days or so (or via a cron job on your host):
```
docker run --rm -it \
  -v $PWD/letsencrypt/etc:/etc/letsencrypt \
  -v $PWD/letsencrypt/lib:/var/lib/letsencrypt \
  certbot/certbot renew
```
Then docker-compose restart to load the new certs.

Why This Is Easier
1.	Avoids Mounting System Folders
Mounting /var/lib/letsencrypt or /etc/letsencrypt from the host can cause permission headaches if your filesystem is read-only or if the Docker daemon lacks write permission.

3.	Keeps Certbot Steps Clear
You generate and manage certificates in a simple, known directory (like ./letsencrypt or ./certs).

4.	Less Volume Complexity
Storing certs locally is straightforward; you only bind-mount them where needed for NGINX.

Recap
•	Option A (Host Certbot): Install Certbot on your host, generate certs in /etc/letsencrypt/, copy them into your project folder, and mount them in Docker.

•	Option B (Docker Certbot): Use a standalone Certbot container, store certs in your project directory, then mount them into NGINX.

Both methods bypass the common pitfalls of trying to mount read-only system directories into Docker. Choose whichever best fits your preference and environment.
